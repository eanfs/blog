
<!DOCTYPE html>
<html lang="" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Richard Blog - 个人记事</title>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="Fechin,"> 
    <meta name="description" content="分享工作中的点点,SolarSpring Cloud为开发者提供了快速构建分布式系统中的一些常见工具，如分布式配置中心，服务发现与注册中心，智能路由，服务熔断及降级，消息总线，分布式追踪的解决方案等。
本次实战以模拟,"> 
    <meta name="author" content="Richard Lee"> 
    <link rel="alternative" href="atom.xml" title="Richard Blog" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <link rel="stylesheet" href="/css/diaspora.css">
</head>

<body class="loading">
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="icon-home image-icon" href="javascript:;"></a>
    <div title="播放/暂停" class="icon-play"></div>
    <h3 class="subtitle">Netflix的TCC柔性事务和EDA事件驱动示例</h3>
    <div class="social">
        <!--<div class="like-icon">-->
            <!--<a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
        <!--</div>-->
        <div>
            <div class="share">
                <a title="获取二维码" class="icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>
    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">Netflix的TCC柔性事务和EDA事件驱动示例</h1>
        <div class="stuff">
            <span>九月 22, 2018</span>
            

        </div>
        <div class="content markdown">
            <h1 id="Solar"><a href="#Solar" class="headerlink" title="Solar"></a>Solar</h1><p>Spring Cloud为开发者提供了快速构建分布式系统中的一些常见工具，如分布式配置中心，服务发现与注册中心，智能路由，服务熔断及降级，消息总线，分布式追踪的解决方案等。</p>
<p>本次实战以模拟下单流程为背景，结合Spring Cloud Netflix和分布式事务解决方案中Try Confirm Cancel模式与基于事件驱动的服务架构作为实战演示。</p>
<h2 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h2><ul>
<li>Docker 1.13.1</li>
<li>Docker Compose 1.11.1</li>
<li>Docker MySQL 5.7.17</li>
<li>Docker RabbitMQ 3.6.6</li>
<li>Java8 with JCE</li>
<li>Spring Cloud Camden.SR6</li>
</ul>
<h2 id="系统结构"><a href="#系统结构" class="headerlink" title="系统结构"></a>系统结构</h2><p><img src="./image/infrastructure2.png" alt=""></p>
<h2 id="Try-Confirm-Cancel-补偿模式"><a href="#Try-Confirm-Cancel-补偿模式" class="headerlink" title="Try Confirm Cancel 补偿模式"></a>Try Confirm Cancel 补偿模式</h2><p>本实例遵循的是Atomikos公司对微服务的分布式事务所提出的<a href="https://www.atomikos.com/Blog/TransactionManagementAPIForRESTTCC" target="_blank" rel="noopener">RESTful TCC</a>解决方案。</p>
<p>RESTful TCC模式分3个阶段执行</p>
<p><img src="./image/tcc.png" alt=""></p>
<ol>
<li>Trying阶段主要针对业务系统检测及作出预留资源请求，若预留资源成功，则返回确认资源的链接与过期时间。</li>
<li>Confirm阶段主要是对业务系统的预留资源作出确认，要求TCC服务的提供方要对确认预留资源的接口实现幂等性，若Confirm成功则返回204，资源超时则证明已经被回收且返回404。</li>
<li>Cancel阶段主要是在业务执行错误或者预留资源超时后执行的资源释放操作，Cancel接口是一个可选操作，因为要求TCC服务的提供方实现自动回收的功能，所以即便是不认为进行Cancel，系统也会自动回收资源。</li>
</ol>
<h2 id="Event-Driven-Architecture-基于事件驱动架构"><a href="#Event-Driven-Architecture-基于事件驱动架构" class="headerlink" title="Event Driven Architecture 基于事件驱动架构"></a>Event Driven Architecture 基于事件驱动架构</h2><p>本实例中的order-ms与membership-ms之间的通信是基于事件驱动的。当订单被成功创建并且付款成功之后，该订单的部分信息将会发往membership-ms以进行积分的增加。</p>
<p>从系统层面看，order-ms在EDA中是属于Publisher角色，自然而然地membership-ms就是Subscriber。</p>
<p>Publisher中的事件状态转换如下：</p>
<ul>
<li>NEW —&gt; PENDING —&gt; DONE</li>
</ul>
<ul>
<li><p>NEW —&gt; PENDING —&gt; FAILED / NO_ROUTE / NOT_FOUND / ERROR</p>
<p><img src="./image/eda-pub.png" alt=""></p>
</li>
</ul>
<p>Subscriber中的事件状态转换如下：</p>
<ul>
<li><p>NEW —&gt; DONE</p>
</li>
<li><p>NEW —&gt; FAILED / NOT_FOUND / ERROR</p>
<p><img src="./image/eda-sub.png" alt=""></p>
</li>
</ul>
<p>部分功能介绍：</p>
<ol>
<li>Publisher发送消息之前先将消息落地，目的是防止消息的错误发布（业务数据被回滚而消息却发布至Broker）。</li>
<li>Publisher会周期性地扫描NEW状态的消息，并发布至Broker。</li>
<li>启用mandatory与publisher confirms机制，在消息被持久化至磁盘后将会收到basic.ack，此时可选择将消息转换为DONE或者是直接将其删除。</li>
<li>Publisher将消息发布至Broker后会将其状态由NEW更新为PENDING，PENDING状态的事件将会由另一定时器扫描在当前时钟的3秒之前发布，但是却并未得到basic.ack的事件，并重新发布至Broker。意在消除在单实例的情况下因crash而导致消息状态丢失的边缘情况。</li>
<li>Subscriber的消息幂等性。</li>
</ol>
<h3 id="基础组件"><a href="#基础组件" class="headerlink" title="基础组件"></a>基础组件</h3><h4 id="Zuul-Gateway"><a href="#Zuul-Gateway" class="headerlink" title="Zuul Gateway"></a>Zuul Gateway</h4><p>Zuul在本实例中仅作为路由所使用，配置降低Ribbon的读取与连接超时上限。</p>
<h4 id="Eureka-H-A"><a href="#Eureka-H-A" class="headerlink" title="Eureka H.A."></a>Eureka H.A.</h4><p>多个对等Eureka节点组成高可用集群，并将注册列表的自我保护的阈值适当降低。</p>
<h4 id="Config-Server"><a href="#Config-Server" class="headerlink" title="Config Server"></a>Config Server</h4><ul>
<li>如果远程配置中有密文<code>{cipher}*</code>，那么该密文的解密将会延迟至客户端启动的时候. 因此客户端需要配置AES的对称密钥<code>encrypt.key</code>，并且客户端所使用的JRE需要安装<a href="http://www.oracle.com/technetwork/java/javase/downloads/jce8-download-2133166.html" target="_blank" rel="noopener">Java 8 JCE</a>，否则将会抛出<code>Illegal key size</code>相关的异常。<br>(本例中Docker Compose构建的容器已经安装了JCE，如果远程配置文件没有使用<code>{cipher}*</code>也不必进行JCE的安装)</li>
</ul>
<ul>
<li><p>为了达到开箱即用，选用公开仓库Github或者GitOsc。</p>
</li>
<li><p>本项目中有两个自定义注解<br><a href="mailto:`@com.github.prontera.Delay" target="_blank" rel="noopener">`@com.github.prontera.Delay</a>` 控制方法的延时返回时间；</p>
<p><a href="mailto:`@com.github.prontera.RandomlyThrowsException" target="_blank" rel="noopener">`@com.github.prontera.RandomlyThrowsException</a>` 随机抛出异常，人为地制造异常。</p>
<p>默认的远程配置如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">solar:</span></span><br><span class="line"><span class="attr">  delay:</span></span><br><span class="line"><span class="attr">    time-in-millseconds:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">  exception:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    factor:</span> <span class="number">7</span></span><br></pre></td></tr></table></figure>
<p>这些自定义配置正是控制方法返回的时延，随机异常的因子等。</p>
<p>我在服务<code>order</code>，<code>product</code>，<code>account</code>和<code>tcc</code>中的所有Controller上都添加了以上两个注解，当远程配置的更新时候，可以手工刷新<code>/refresh</code>或通过webhook等方法自动刷新本地配置. 以达到模拟微服务繁忙或熔断等情况。</p>
</li>
</ul>
<h3 id="监控服务"><a href="#监控服务" class="headerlink" title="监控服务"></a>监控服务</h3><h4 id="Spring-Boot-Admin"><a href="#Spring-Boot-Admin" class="headerlink" title="Spring Boot Admin"></a>Spring Boot Admin</h4><p>此应用提供了管理Spring Boot服务的简单UI，下图是在容器中运行时的服务健康检测页</p>
<p><img src="./image/spring-boot-admin.jpg" alt=""></p>
<h4 id="Hystrix-Dashboard"><a href="#Hystrix-Dashboard" class="headerlink" title="Hystrix Dashboard"></a>Hystrix Dashboard</h4><p>提供近实时依赖的统计和监控面板，以监测服务的超时，熔断，拒绝，降级等行为。</p>
<p><img src="./image/turbine.jpg" alt=""></p>
<h4 id="Zipkin-Server"><a href="#Zipkin-Server" class="headerlink" title="Zipkin Server"></a>Zipkin Server</h4><p>Zipkin是一款开源的分布式实时数据追踪系统，其主要功能是聚集来自各个异构系统的实时监控数据，用来追踪微服务架构下的系统时延问题. 下图是对<code>order</code>服务的请求进行追踪的情况。</p>
<p><img src="./image/zipkin.jpg" alt=""></p>
<h3 id="业务服务"><a href="#业务服务" class="headerlink" title="业务服务"></a>业务服务</h3><p>首次启动时通过Flyway自动初始化数据库。</p>
<p>对spring cloud config server采用fail fast策略，一旦远程配置服务无法连接则无法启动业务服务。</p>
<h4 id="account"><a href="#account" class="headerlink" title="account"></a>account</h4><p>用于获取用户信息，用户注册，修改用户余额，预留余额资源，确认预留余额，撤销预留余额。</p>
<h4 id="product"><a href="#product" class="headerlink" title="product"></a>product</h4><p>用于获取产品信息，变更商品库存，预留库存资源，确认预留库存，撤销预留库存。</p>
<h4 id="tcc-coordinator"><a href="#tcc-coordinator" class="headerlink" title="tcc coordinator"></a>tcc coordinator</h4><p>TCC资源协调器，其职责如下：</p>
<ul>
<li>对所有参与者发起Confirm请求。</li>
<li>无论是协调器发生的错误还是调用参与者所产生的错误，协调器都必须有自动恢复重试功能，尤其是在确认的阶段，以防止网络抖动的情况。</li>
</ul>
<h4 id="order"><a href="#order" class="headerlink" title="order"></a>order</h4><p><strong><code>order</code>服务是本项目的入口</strong>，尽管所提供的功能很简单：</p>
<ul>
<li>下单. 即生成预订单，为了更好地测试TCC功能，在下单时就通过Feign向服务<code>account</code>与<code>product</code>发起预留资源请求，并且记录入库。</li>
<li>确认订单. 确认订单时根据订单ID从库中获取订单，并获取预留资源确认的URI，交由服务<code>tcc</code>统一进行确认，如果发生冲突即记录入库，等待人工处理。</li>
</ul>
<p><img src="./image/zipkin-dep.jpg" alt=""></p>
<h4 id="membership"><a href="#membership" class="headerlink" title="membership"></a>membership</h4><p>用于订单付款成功后，对下单用户的积分进行增加操作。该服务与订单服务是基于消息驱动以进行通信，达到事务的最终一致性。</p>
<h3 id="Swagger-UI"><a href="#Swagger-UI" class="headerlink" title="Swagger UI"></a>Swagger UI</h3><p>下图为<code>product</code>服务的Swagger接口文档，根据下文的服务字典可知，本接口文档可通过<code>http://localhost:8040/swagger-ui.html</code>进行访问.  <code>order</code>，<code>account</code>和<code>tcc</code>的文档访问方式亦是如出一撤。</p>
<p><img src="./image/swagger-product.jpg" alt=""></p>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><h4 id="Docker-Compose运行"><a href="#Docker-Compose运行" class="headerlink" title="Docker Compose运行"></a>Docker Compose运行</h4><p>在项目根路径下执行脚本<code>build.sh</code>，该脚本会执行Maven的打包操作，并会迭代目录下的<code>*-compose.yml</code>进行容器构建。</p>
<p>构建完成后需要按照指定的顺序启动，需要注意的一点是容器内服务的启动是需要备留预热时间，并非Docker容器启动后容器内的所有服务就能马上启动起来，要注意区分<strong>容器的启动</strong>和<strong>容器内的服务的启动</strong>，建议配合docker-compse logs来观察启动情况。而且容器之间的服务是有依赖的，如<code>account-ms</code>和<code>product-ms</code>此类业务服务的启动是会快速失败于<code>config-ms</code>的失联。所以建议按照以下顺序启动Docker容器，并且在一组Docker容器<strong>服务完全启动</strong>后，再启动下一组的Docker容器。</p>
<ol>
<li><p>启动MySQL，RabbitMQ等基础组件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f infrastructure-compose.yml up -d</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动Eureka Server与Config Server</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f basic-ms-compose.yml up -d</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动监控服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f monitor-ms-compose.yml up -d</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动业务服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f business-ms-compose.yml up -d</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="IDE运行"><a href="#IDE运行" class="headerlink" title="IDE运行"></a>IDE运行</h4><p>因为程序本身按照Docker启动，所以对于hostname需要在hosts文件中设置正确才能正常运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># solar</span></span></span><br><span class="line">127.0.0.1 eureka1</span><br><span class="line">127.0.0.1 eureka2</span><br><span class="line">127.0.0.1 rabbitmq</span><br><span class="line">127.0.0.1 zipkin_server</span><br><span class="line">127.0.0.1 solar_mysql</span><br><span class="line">127.0.0.1 gitlab</span><br></pre></td></tr></table></figure>
<p>根据依赖关系，程序最好按照以下的顺序执行</p>
<p>docker mysql &gt; docker rabbitmq &gt; eureka server &gt; config server &gt; zipkin server &gt; 其他业务微服务（account-ms, product-ms, order-ms, tcc-coordinator-ms等）</p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>根据附表中的服务字典，我们通过Zuul或Swagge对<code>order</code>服务进行预订单生成操作。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST http://localhost:7291/order/api/v1/orders</span><br><span class="line"><span class="attribute">Content-Type</span>: application/json;charset=UTF-8</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "product_id": 7,</span><br><span class="line">  "user_id": 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>成功后我们将得到预订单的结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">15</span>,</span><br><span class="line">    <span class="attr">"create_time"</span>: <span class="string">"2017-03-28T18:18:02.206+08:00"</span>,</span><br><span class="line">    <span class="attr">"update_time"</span>: <span class="string">"1970-01-01T00:00:00+08:00"</span>,</span><br><span class="line">    <span class="attr">"delete_time"</span>: <span class="string">"1970-01-01T00:00:00+08:00"</span>,</span><br><span class="line">    <span class="attr">"user_id"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"product_id"</span>: <span class="number">7</span>,</span><br><span class="line">    <span class="attr">"price"</span>: <span class="number">14</span>,</span><br><span class="line">    <span class="attr">"status"</span>: <span class="string">"PROCESSING"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"code"</span>: <span class="number">20000</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时我们再确认订单</p>
<p>(如果想测试预留资源的补偿情况，那么就等15s后过期再发请求，注意容器与宿主机的时间)</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST http://localhost:7291/order/api/v1/orders/confirmation</span><br><span class="line"><span class="attribute">Content-Type</span>: application/json;charset=UTF-8</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "order_id": 15</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果成功确认则返回如下结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"data"</span>: &#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">15</span>,</span><br><span class="line">    <span class="attr">"create_time"</span>: <span class="string">"2017-03-28T18:18:02.206+08:00"</span>,</span><br><span class="line">    <span class="attr">"update_time"</span>: <span class="string">"2017-03-28T18:21:32.78+08:00"</span>,</span><br><span class="line">    <span class="attr">"delete_time"</span>: <span class="string">"1970-01-01T00:00:00+08:00"</span>,</span><br><span class="line">    <span class="attr">"user_id"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"product_id"</span>: <span class="number">7</span>,</span><br><span class="line">    <span class="attr">"price"</span>: <span class="number">14</span>,</span><br><span class="line">    <span class="attr">"status"</span>: <span class="string">"DONE"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"code"</span>: <span class="number">20000</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此就完成了一次TCC事务，当然你也可以测试超时和冲突的情况，这里就不再赘述。</p>
<h2 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h2><h3 id="使用Gitlab作为远程配置仓库"><a href="#使用Gitlab作为远程配置仓库" class="headerlink" title="使用Gitlab作为远程配置仓库"></a>使用Gitlab作为远程配置仓库</h3><p>本例中默认使用Github或GitOsc中的公开仓库，出于自定义的需要，我们可以在本地构建Git仓库，这里选用Gitlab为例。</p>
<p>将以下配置添加至docker compose中的文件中并启动Docker Gitlab容器：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">gitlab:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">daocloud.io/daocloud/gitlab:8.16.7-ce.0</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"10222:22"</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"80:80"</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"10443:443"</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"./docker-gitlab/config/:/etc/gitlab/"</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"./docker-gitlab/logs/:/var/log/gitlab/"</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"./docker-gitlab/data/:/var/opt/gitlab/"</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">TZ=Asia/Shanghai</span></span><br></pre></td></tr></table></figure>
<p>将项目的<code>config-repo</code>添加至Gitlab中，并修改<code>config-ms</code>中git仓库的相关验证等参数即可。</p>
<p><img src="./image/gitlab.jpg" alt=""></p>
<h2 id="服务字典"><a href="#服务字典" class="headerlink" title="服务字典"></a>服务字典</h2><p>鉴于Spring Boot Actuator的端点所带来的两面性，除了可以增加<code>spring-boot-starter-security</code>来获得强度较弱的HTTP Basic认证外，我们还可以修改<code>management.port</code>和<code>management.context-path</code>来提高攻击成本. 是的，我对每一个服务都修改了以上两个属性，并且兼容了Eureka Server，Hystrix Dashboard，Spring Boot Admin，使这些监控服务仍能正确工作. 因为对以上两个参数修改，我们的监控路径有所变化，如下表：</p>
<table>
<thead>
<tr>
<th style="text-align:center">module name</th>
<th style="text-align:center">docker compose service name</th>
<th style="text-align:center">application name</th>
<th style="text-align:center">server port</th>
<th style="text-align:center">management port</th>
<th style="text-align:center">management context path</th>
<th style="text-align:center">scalable</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">account-ms</td>
<td style="text-align:center">account</td>
<td style="text-align:center">account</td>
<td style="text-align:center">10014</td>
<td style="text-align:center">10248</td>
<td style="text-align:center"><strong>/78d504ff-82e8-4a87-82e8-724d72d1171b</strong></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">api-gateway-ms</td>
<td style="text-align:center">gateway</td>
<td style="text-align:center">gateway</td>
<td style="text-align:center">7291</td>
<td style="text-align:center">10211</td>
<td style="text-align:center">/fb83deee-dd46-472b-99a9-f0ebffe20d0e</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">config-ms</td>
<td style="text-align:center">config_server</td>
<td style="text-align:center">config-server</td>
<td style="text-align:center">10888</td>
<td style="text-align:center">10481</td>
<td style="text-align:center">/f7597180-e480-400e-81a0-847c22e2e0b8</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">eureka-registry-ms-1</td>
<td style="text-align:center">eureka1</td>
<td style="text-align:center">registry</td>
<td style="text-align:center">8763</td>
<td style="text-align:center">9274</td>
<td style="text-align:center">/55395018-70b7-47c3-8fef-5bf24c9da9af</td>
<td style="text-align:center">×</td>
</tr>
<tr>
<td style="text-align:center">eureka-registry-ms-2</td>
<td style="text-align:center">eureka2</td>
<td style="text-align:center">registry</td>
<td style="text-align:center">8762</td>
<td style="text-align:center">10177</td>
<td style="text-align:center">/e5da837b-a575-4447-b037-100850226a11</td>
<td style="text-align:center">×</td>
</tr>
<tr>
<td style="text-align:center">hystrix-dashboard-ms</td>
<td style="text-align:center">hystrix_dashboard</td>
<td style="text-align:center">hystrix</td>
<td style="text-align:center">8193</td>
<td style="text-align:center">7104</td>
<td style="text-align:center">/9511d89d-6488-4293-8df8-c4feb8681e83</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">membership-ms</td>
<td style="text-align:center">membership</td>
<td style="text-align:center">membership</td>
<td style="text-align:center">10673</td>
<td style="text-align:center">10391</td>
<td style="text-align:center">/a6da3b6f-4b59-11e7-9226-0242ac130004</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">order-ms</td>
<td style="text-align:center">order</td>
<td style="text-align:center">order</td>
<td style="text-align:center">8295</td>
<td style="text-align:center">10848</td>
<td style="text-align:center"><strong>/78d504ff-82e8-4a87-82e8-724d72d1171b</strong></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">product-ms</td>
<td style="text-align:center">product</td>
<td style="text-align:center">product</td>
<td style="text-align:center">8040</td>
<td style="text-align:center">10912</td>
<td style="text-align:center"><strong>/78d504ff-82e8-4a87-82e8-724d72d1171b</strong></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">spring-boot-admin-ms</td>
<td style="text-align:center">spring_boot_admin</td>
<td style="text-align:center">spring-boot-admin</td>
<td style="text-align:center">7020</td>
<td style="text-align:center">9218</td>
<td style="text-align:center">/e58a0ff5-9f60-4545-9aa2-2b91c8a6d53b</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">tcc-coordinator-ms</td>
<td style="text-align:center">tcc_coordinator</td>
<td style="text-align:center">tcc</td>
<td style="text-align:center">11020</td>
<td style="text-align:center">12841</td>
<td style="text-align:center"><strong>/78d504ff-82e8-4a87-82e8-724d72d1171b</strong></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">zipkin-ms</td>
<td style="text-align:center">zipkin_server</td>
<td style="text-align:center">zipkin-server</td>
<td style="text-align:center">9411</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">×</td>
</tr>
</tbody>
</table>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>感谢你的耐心阅读，如有对本项目中的Spring Cloud的使用或者对本人的编码风格有更好的想法或者建议，欢迎通过邮件与我取得联系，万分感谢。</p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        <li title='0' data-url='http://link.hhtjim.com/163/5146554.mp3'></li>
                    
                        <li title='1' data-url='http://link.hhtjim.com/qq/001faIUs4M2zna.mp3'></li>
                    
                </ul>
            
        </div>
        
    <div id='gitalk-container' class="comment link"
        data-ae='false'
        data-ci=''
        data-cs=''
        data-r=''
        data-o=''
        data-a=''
        data-d='false'
    >查看评论</div>


    </div>
    
</div>


    </div>
</div>
</body>
<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/diaspora.js"></script>
<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">
<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>




</html>